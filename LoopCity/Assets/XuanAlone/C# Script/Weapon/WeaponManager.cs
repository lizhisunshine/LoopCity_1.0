using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public enum WeaponType { MagicWand, EnergyBlaster, FrostScepter }

public class WeaponManager : MonoBehaviour
{

    [Header("子弹预制体")]
    public GameObject magicWandBullet; // 魔法棒原始子弹
    private GameObject originalWandBullet; // 存储原始子弹

    [Header("Weapon References")]
    public GameObject magicWand;
    public GameObject energyBlaster;
    public GameObject frostScepter;

    [Header("UI Elements")]
    public Image weaponIcon;
    public TMP_Text weaponName;
    public TMP_Text keyHint;

    [Header("Weapon Sprites")]
    public Sprite wandSprite;
    public Sprite blasterSprite;
    public Sprite scepterSprite;

    private WeaponType currentWeapon = WeaponType.MagicWand;
    private Dictionary<WeaponType, GameObject> weaponObjects;

    void Start()
    {
        // 初始化武器对象字典
        weaponObjects = new Dictionary<WeaponType, GameObject>
        {
            { WeaponType.MagicWand, magicWand },
            { WeaponType.EnergyBlaster, energyBlaster },
            { WeaponType.FrostScepter, frostScepter }
        };

        // 禁用所有武器
        DisableAllWeapons();

        // 保存原始子弹
        if (magicWandBullet != null)
        {
            originalWandBullet = magicWandBullet;
        }

        // 激活初始武器
        SwitchWeapon(currentWeapon);
        UpdateUI();

        // 设置按键提示
        keyHint.text = "E";
    }

    // 禁用所有武器
    private void DisableAllWeapons()
    {
        foreach (var weapon in weaponObjects.Values)
        {
            if (weapon != null)
            {
                weapon.SetActive(false);
            }
        }
    }

    void Update()
    {
        if (Input.GetKeyDown(KeyCode.E))
        {
            CycleWeapon();
        }
    }

    private void CycleWeapon()
    {
        // 按顺序循环切换武器
        switch (currentWeapon)
        {
            case WeaponType.MagicWand:
                SwitchWeapon(WeaponType.EnergyBlaster);
                break;
            case WeaponType.EnergyBlaster:
                SwitchWeapon(WeaponType.FrostScepter);
                break;
            case WeaponType.FrostScepter:
                SwitchWeapon(WeaponType.MagicWand);
                break;
        }
    }

    private void SwitchWeapon(WeaponType newWeapon)
    {
        // 保存当前魔法棒的子弹（如果当前是魔法棒）
        if (currentWeapon == WeaponType.MagicWand && magicWandBullet != null)
        {
            originalWandBullet = magicWandBullet;
        }

        // 禁用当前武器
        if (weaponObjects.ContainsKey(currentWeapon) && weaponObjects[currentWeapon] != null)
        {
            weaponObjects[currentWeapon].SetActive(false);
        }

        // 启用新武器
        currentWeapon = newWeapon;
        if (weaponObjects.ContainsKey(currentWeapon) && weaponObjects[currentWeapon] != null)
        {
            weaponObjects[currentWeapon].SetActive(true);
        }

        // 特殊处理：从魔法弓切换回魔法棒时恢复原始子弹
        if (newWeapon == WeaponType.MagicWand && currentWeapon == WeaponType.FrostScepter)
        {
            if (originalWandBullet != null)
            {
                magicWandBullet = originalWandBullet;
            }
        }


        // 更新玩家黑板中的武器信息和子弹
        Player_FSM player = FindObjectOfType<Player_FSM>();
        if (player != null && player.blackboard != null)
        {
            player.blackboard.currentWeapon = currentWeapon;

            // 更新子弹预制体
            if (currentWeapon == WeaponType.MagicWand)
            {
                player.blackboard.bulletPrefab = magicWandBullet;
            }
        }
        // 更新UI
        UpdateUI();

        // 添加切换效果
        StartCoroutine(WeaponSwitchEffect());
    }

    private void UpdateUI()
    {
        switch (currentWeapon)
        {
            case WeaponType.MagicWand:
                weaponIcon.sprite = wandSprite;
                weaponName.text = "Magic Wand";
                weaponName.color = new Color(1f, 0.95f, 0.4f);
                break;
            case WeaponType.EnergyBlaster:
                weaponIcon.sprite = blasterSprite;
                weaponName.text = "Magic Book";
                weaponName.color = new Color(0.2f, 0.8f, 1f);
                break;
            case WeaponType.FrostScepter:
                weaponIcon.sprite = scepterSprite;
                weaponName.text = "Magic Bow";
                weaponName.color = new Color(1f, 0.4f, 0.6f);
                break;
        }

        // 添加文本效果
        weaponName.fontStyle = FontStyles.Bold;
        weaponName.alignment = TextAlignmentOptions.Center;
    }

    // 武器切换时的视觉效果
    private IEnumerator WeaponSwitchEffect()
    {
        Vector3 originalScale = weaponIcon.transform.localScale;
        weaponIcon.transform.localScale = originalScale * 1.3f;

        yield return new WaitForSeconds(0.1f);

        weaponIcon.transform.localScale = originalScale;
    }
}